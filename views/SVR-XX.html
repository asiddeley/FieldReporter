<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title id='browserTab' >browserTab</title>
<style>
fieldset {border: 0;}
.savable {width:200px;}
label {display: block;  margin: 30px 0 0 0; }
select {width: 200px; }
.overflow {height:200px;}
.left-border {border-left:2px solid #000;}
.marz{margin-top:0px; margin-bottom:0px;}
.col-first{border-right:2px solid #000;}
.row_{border-bottom:1px solid #aaa;}
.row__{border-top:2px solid #000; border-bottom:1px solid #aaa;} 

p, h2, h3, strong {font-family:'segoe';}

textarea {
font-family:'segoe';
background-color:silver;
}


.pocket {
	margin:5px;
	padding:5px;
	height:250px;
	display:block;
	border:1px solid gray;
}
.pocket-caption{height:20px;}
.pocket-row{height:300px;}
</style>


<script type='text/javascript'>


function commentsDelete(){

	//get row that called the menu, caller is set by showMenu() 
	var caller=CM$.menu("option", 'caller'); 
	
	//index of that was clicked
	var rowid=$(caller).attr("rowid");
	//console.log("Delete rowid",rowid);	
	
	//index of that was clicked
	var index=parseInt($(caller).attr("rank"));
	
	//exit early if delete made from header row or problem with rowid
	if (index==0 || typeof rowid=="undefined") {return;}

	//delete from database
	database(SQLdeleteComments(rowid));

	//refresh comments
	database(SQLselectComments(cpnum, csvrnum),	function(result){
		//console.log("delete refresh result < CC... ", result.rows.length, commentsCount, (typeof rowid), rowid);
		
		//test if DELETE actually removed a row then update rank column for remaining rows
		if (result.rows.length < commentsCount){
			//console.log("# selected for deletion..." ,$("#commentsRow"+rowid).length);
			//grand send off and removal 
			$("#commentsRow"+rowid).css('background','tan').hide(500, function(){
				var u1="UPDATE comments SET itemno=itemno-1 "+
				"WHERE pnum='"+cpnum+"' AND svrnum='"+csvrnum+"' AND CAST (itemno AS INTEGER) > "+index;
				database(u1);
				commentsRender();
			});
		}
	});

};

function commentsInsert(){

	//get row that called the menu, caller is set by showMenu() 
	var caller=CM$.menu("option", 'caller'); 
	
	//index of that was clicked
	var index=parseInt($(caller).attr("rank"));
	
	//Make way for newbie...
	var u1="UPDATE comments SET itemno=itemno+1 "+
	"WHERE pnum='"+cpnum+"' AND svrnum='"+csvrnum+"' AND CAST (itemno AS INTEGER) > "+index;
	database(u1);
	
	//Add newbie... Substitute itemno 
	var newrow=$.extend({}, commentsEntry, {itemno:(Number(index)+1), comment:"new comment"}); 
	database(SQLinsertComments(newrow));

	commentsRender(function(){
		//grand reveal for the new row 
		$('#comments-placeholder').children('[rank="'+(index+1)+'"]').css('background','tan').hide().show(500);
	});

	CM$.hide();
};

function commentsRender(posteffect){

	if (typeof cpnum == "undefined") {alert("Please specify a project number under Welcome tab.");}
	else {
		database(SQLselectComments(cpnum, csvrnum),	function(result){
			//commentsCount is a global variable thats used to determine whether delete operations are successfull 
			commentsCount=result.rows.length;
			$('#comments-placeholder').html(commentsTemplate(result));
			try {posteffect();} catch(err){ }
		});
	}	
}

function commentsUpdate(){

	//get row that called the menu, caller is set by showMenu() 
	var caller=CM$.menu("option", 'caller'); 
	
	//index of that was clicked
	var rowid=$(caller).attr("rowid");
	
	//database(SQLupdateComments(row, rowid), function(r){console.log(r);});
	
	////refresh comments
	//database(SQLselectComments(cpnum, csvrnum),	function(result){
	//	$('#comments-placeholder').html(commentsTemplate(result));
	//});
};


function highlightCaller(on) {
	//if (on==1) $(CM2.caller()).css('background-color','pink');
	//else $(CM2.caller()).css('background-color','white');
};

function highlite(that){
	$(".highlite").css("background-color","white");
	$(that).css("background-color","skyblue");
}

function showMenu(cm$, ev){	
	texteditor(); //call texteditor with no arguments to turn it off in case its on
	cm$.show().position({my:'left top',	at:'left bottom', of:ev});
	//remember caller, that is the <div> or <p> element that launched the contextMenu
	cm$.menu('option', 'caller', ev.target);
	return false;
};

function selectFolder(e) {
    var theFiles = e.target.files;
    var relativePath = theFiles[0].webkitRelativePath;
    var folder = relativePath.split("/");
    alert(folder[0]);
};


var SQLdeleteComments=function(rowid){
	var sql= "DELETE FROM comments WHERE rowid="+rowid;
	//console.log("SQL...", sql);
	return sql;
};

var SQLselectComments=function(pnum, svrnum){
	var sql= "SELECT rowid, * FROM comments WHERE pnum='"+pnum+
	"' AND svrnum='"+svrnum+
	"' ORDER BY CAST (itemno AS INTEGER) ASC";
	return sql;
};

var SQLinsertComments=function (row){
	var keys=Object.keys(row); //array of keys
	var vals=keys.map( function(k){return ("'"+row[k]+"'");} ); //array of quoted values
	var sql="INSERT INTO comments ( " + keys.join(", ") + " ) VALUES ( "+vals.join(", ")+" )";
	//console.log("SQL:", a1);
	return sql;
};

var SQLupdateComments=function (row, rowid){
	var keys=Object.keys(row); //array of keys
	var vals=keys.map( function(k){return ("'"+row[k]+"'");} ); //array of quoted values
	var sql="UPDATE comments ( " + keys.join(", ") +
	" ) VALUES ( "+vals.join(", ")+
	" ) WHERE rowid="+rowid;
	console.log("SQL:", sql);
	return sql;
};

//var texteditorCount=0;

function texteditorFit(){
	console.log("texteditor Fit");
	var x$=$("#texteditor");
	var e$=$("[edit-in-progress=1]"); //attribute selector 
	//fit textarea to element	
	x$.width(e$.width());
	x$.css("height","auto");
	x$.css("padding-left", e$.css("padding-left"));
	if (x$[0].scrollHeight > 0) {x$.css("height", x$[0].scrollHeight);}
	//element to match textarea height
	e$.height(x$.height()+5);
	//this needs to be done last per trial-and-error
	x$.show().position({my:'left top', at:'left top', of:e$});
};

function texteditor(element){
	//console.log("TEXT edit...", texteditorCount); texteditorCount+=1;
	var x$=$("#texteditor");

	//turn-off editor
	if(typeof element=="undefined"){
		//restore row height of previously accessed elements 
		$(".texteditor").css("height","auto");
		x$.hide();
		$(window).off("resize", texteditorFit);
		return;
	}

	//activate texteditor on element
	var e$=$(element);
	
	//restore row height of previously accessed elements and unflag
	$(".texteditor").css("height","auto");
	//clear flags
	$("[edit-in-progress]").attr("edit-in-progress",0);
	//flag current element being edited
	e$.attr("edit-in-progress", 1);
	
	//initialize various events...
	//x$.off("click keyup resize", texteditorFit).on("click keyup resize", texteditorFit);
	$(window).off("resize", texteditorFit).on("resize", texteditorFit);

	x$.val( e$.text() );	
	texteditorFit();	
};

//Global variable reserved for Context Menu for Section 2, 3 & 4.  Initialized later
var CM$; 
var commentsCount=0;
var commentsTemplate;
var cpnum=getCookie("cpnum");
var csvrnum=getCookie("csvrnum");
if (csvrnum==null){csvrnum=setCookie("csvrnum", "SVR-001", "30");}
var commentsEntry={
	itemno:"1", 
	pnum:cpnum, 
	svrnum:csvrnum, 
	comment:"New comment",
	refs:"--"
};


//READY
$(function() { 

	//initialize context menu...
	CM$=$("#commentsMenu").menu().css("position","absolute", "width", "200px").hide();
	//initialize various events...
	$("#texteditor").on("click keyup resize", texteditorFit);

	// Setup Handlebars
	// handlebars.registerHelper("plusOne", function(obj){return Number(obj.data.index)+1;});

	// get template html then compile it to a template-function, commentsTemplate is global
	commentsTemplate = Handlebars.compile($("#comments-template").html());
	commentsRender();

	

}); //READY



</script>

</head>



<body>


<!-- TEMPLATES               -->
<template id='comments-template' type="text/x-handlebars-template">

	{{#each rows}}
	<div class="row marz highlite"
		id="commentsRow{{rowid}}"
		rank={{itemno}} 
		rowid={{rowid}}
		onmouseenter='highlite(this)'
		oncontextmenu='showMenu(CM$, event)'>
	<p 	rank={{itemno}}
		rowid={{rowid}}
		class='col-xs-1 col-first marz'>2.{{itemno}}</p>
	<p 	rank={{itemno}}
		rowid={{rowid}}
		onclick="texteditor(this)"
		class="col-xs-10 marz texteditor">{{comment}}</p>	
	<p 	rank={{itemno}}
		rowid={{rowid}}
		class='col-xs-1 marz'>{{rowid}}</p>	
	</div>
	{{/each}}	
</template>

<!-- p id='itemNo' indexx={{@index}} class='col-xs-1 itemNo col-first marz'>
{{#indexPlusOne @index}}{{/indexPlusOne}} 
</p -->

<!-- MENUS -->
<div id="commentsMenu" onmouseleave="CM$.hide()" style="display:none; z-index:10000">
	<!--p onclick='commentsInsert(0)'>Insert before</p-->
	<p onclick="commentsInsert()">Add new comment</p>
	<p onclick="commentsDelete()">Delete</p>
	<!-- p onclick='console.log("Move up");$("#rowOptions").hide();'>Move up</p>
	<p onclick='console.log("Move dn");$("#rowOptions").hide();'>Move dn</p 
	-->
	<p onclick='CM$.hide()'>Exit</p>
</div>

<textarea id="texteditor" style="display:none; z-index:999" ></textarea>

<!-- PAGE STARTS HERE -->

<div class='container'>
	<img src='./images/private/logo.png' style='width:100px; float:left;'>
	<h2  style='float:right;' >Field Review Report</h2><div style='clear:both'></div>
	<br><br>

	<div class='row row__'>
		<strong class='col-xs-2'>Report No:</strong>
		<p id='docName' class='col-xs-4'>SVR-A01</p>
		<strong class='col-xs-2'>Permit No:</strong>
		<p id='permitNo' class='col-xs-4 soup-cell'>16 xxxxxx BLD 00 BA</p>
	</div>

	<div class='row row_'>
		<strong class='col-xs-2'>Project:</strong>
		<p class='col-xs-4'>Some Street Building Redevelopment</p>
		<strong class='col-xs-2'>Date of Visit:</strong>
		<p id='visitDate' class='col-xs-4 soup-cell'>June 15 &amp; 17, 2016</p>
	</div>
	
	<div class='row row_'>
		<strong class='col-xs-2'>Project No.:</strong>
		<p class='col-xs-4'>BLDG-0001</p>
		<strong class='col-xs-2'>Time of Visit:</strong>
		<p id='visitTime' class='col-xs-4 soup-cell'>4pm to 6pm</p>
	</div>
				
	<div class='row row_'>
		<strong class='col-xs-2'>Project Location:</strong>
		<p class='col-xs-4'>123 Some Street, City, Prov, M5B 1W8</p>
		<strong class='col-xs-2'>Reviewer:</strong>
		<p id='reviewerName' class='col-xs-4 soup-cell'>Andrew Siddeley</p>
	</div>

	<div class='row row_'>
		<strong class='col-xs-2'>Contractor:</strong>
		<p class='col-xs-4'>GC</p>
		<strong class='col-xs-2'>Date of Report:</strong>
		<p id='reportDate' class='col-xs-4 soup-cell'>Jun 17, 2016</p>
	</div>
	
	<div class='row row_'>
		<p id='generalStatement' class='col-xs-12' >This report is a general review of progress and construction activities on site.  Architectural Work was visually reviewed on a random basis for general conformity with Architectural Contract Documents prepared by this firm.  Refer also to Mechanical and Electrical field reports issued separately.  
		</p>
	</div>	

	<br><br>

	<div class='row marz'>
		<h3 class='col-xs-1 col-first marz'>1.0</h3>
		<h3 class='col-xs-10 marz'>General</h3>
		<h3 class='col-xs-1 marz'>Ref.</h3>
	</div>
	
	<div class='row marz'>
		<p class='col-xs-1 col-first marz'>1.1</p>
		<p id='generalComment' class='col-xs-10 marz' >general comment</p>
		<p class='col-xs-1 marz'>--</p>
	</div>

	<div class='row marz highlite' rank=0
		onmouseenter='highlite(this)'
		oncontextmenu='showMenu(CM$, event)' >
		<h3 class='col-xs-1 col-first marz' rank=0>2.0</h3>
		<h3 class='col-xs-10 marz' rank=0>Observatons and Comments</h3>
		<h3 class='col-xs-1 marz' rank=0>Pic.</h3>
	</div>
	
	<!-- Placeholder for comments -->
	<div id='comments-placeholder' class='marz'></div>


	<div class='row marz highlite' onmouseenter='highlite(this)'>
		<h3 class='col-xs-1 col-first marz'>3.0</h3>
		<h3 class='col-xs-10 marz'>Issues Resolved</h3>
		<h3 class='col-xs-1 marz'>Ref</h3>
	</div>
	

	<div id='resolved' class='soup-foreach marz' soup-foreach='[1]'  >
		<div class='row marz highlite' 
			onmouseenter='highlite()'
			oncontextmenu='showMenu(CM2, event)'
		>
		<p id='itemNo' class='col-xs-1 col-first itemNo marz' soup-action='$(this.child).text(this.child.foreachIndex1);'>99</p>
		<p id='resolved' class='col-xs-10 comment marz' soup-action='soup.idfix(this.child, this.item).cell(this.child);'>comment</p>
		<p id='picNo' class='col-xs-1 picNo marz' soup-action='soup.idfix(this.child, this.item).cell(this.child);'>pic</p>
		</div>
	</div>
	
	<div class='row marz'>
		<h3 class='col-xs-1 col-first marz'>4.0</h3>
		<h3 class='col-xs-10 marz'>Issues Outstanding</h3>
		<h3 class='col-xs-1 marz'>Ref</h3>
	</div>
	<div id='outstanding' soup-foreach='[1]'  >
		<div class='row marz'  soup-template='+1'
			onmouseenter='$(this).css("background-color","pink")'
			onmouseleave='$(this).css("background-color","white")'
			oncontextmenu='showMenu(CM2, event)'
		>
		<p id='itemNo' class='col-xs-1 col-first itemNo marz' soup-action='$(this.child).text(this.child.foreachIndex1);'>99</p>
		<p id='outstanding' class='col-xs-10 comment marz' soup-action='soup.idfix(this.child, this.item).cell(this.child);'>comment</p>
		<p id='picNo' class='col-xs-1 picNo marz' soup-action='soup.idfix(this.child, this.item).cell(this.child);'>pic</p>
		</div>
	</div>

	<div class='row marz'>
		<h3 class='col-xs-1 col-first marz'>5.0</h3>
		<h3 class='col-xs-10 marz'>Pictures</h3>
		<h3 class='col-xs-1 marz'>Pic.</h3>
	</div>
	
	<div id='pictures' class='marz' soup-foreach='[1, 2]'  >
		<div 
			class='row marz' 
			style='height:300px; display:block'
			onmouseenter='$(this).css("background-color","pink");'
			onmouseleave='$(this).css("background-color","white");'

		>
			<div class='col-xs-4'>
				<div 
					id='pocket_a'
					class='pocket'
					ondragenter='$(this).css("background-color","pink");'
					ondragleave='$(this).css("background-color","white");'
					soup-pocket
					soup-action-HOLD='soup.idfix(this.child, this.item).pocket(this.child);'
					soup-action='soup.idfix(this.child, this.item);'
					soup-imgpath='albums/test/'
				></div>
				<p
					id='caption_pocket_a' class='pocket-caption'
					soup-action='soup.idfix(this.child, this.item);soup.cell(this.child);'					
				>='Row:' + $(this.element).prop('foreachItem')</p>
			</div>
			
			<div class='col-xs-4'>
				<div 
					id='pocket_b'
					class='pocket'
					ondragenter='$(this).css("background-color","pink");'
					ondragleave='$(this).css("background-color","white");'		
					soup-pocket
					soup-action-HOLD='soup.idfix(this.child, this.item).pocket(this.child);'
					soup-action='soup.idfix(this.child, this.item);'
					soup-imgpath='albums/test/'
				></div>
				<p
					id='caption_pocket_b' class='pocket-caption'
					soup-action='soup.idfix(this.child, this.item).cell(this.child);'					
				>caption</p>
			</div>
			
			<div class='col-xs-4'>
				<div 
					id='pocket_c'
					class='pocket'
					ondragenter='$(this).css("background-color","pink");'
					ondragleave='$(this).css("background-color","white");'			
					soup-action-HOLD='soup.idfix(this.child, this.item).pocket(this.child);'
					soup-pocket
					soup-action='soup.idfix(this.child, this.item);'
					soup-imgpath='albums/test/'
				></div>
				<p
					id='caption_pocket_c' class='pocket-caption'
					soup-action='soup.idfix(this.child, this.item).cell(this.child);'					
				>caption</p>
			</div>			

		
		</div>
	</div>
	<br>
	<br>
		
	<br>
	<br>
</div>


</body>

</html>


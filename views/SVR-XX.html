<!doctype html>

<script type='text/javascript'>
//console.log("SCRIPT...");
///// Global defs

$PP.get("$pnum","BLDG-001");
$PP.get("$dnum","SVR-A01");


function selectFolder(e) {
    var theFiles = e.target.files;
    var relativePath = theFiles[0].webkitRelativePath;
    var folder = relativePath.split("/");
    alert(folder[0]);
};

///// TableViews
// Site visit report
var svr={};

svr.titleblock={};
svr.titleblock.tv=new TableView(casbah.projects($PP), {
	filter:"pnum=$pnum", 
	refresh:function(result, delta){
		renderFX("document-titleblock", svr.titleblock.template, result, delta);
	}}
);


svr.tv=new TableView(casbah.siteVisitReports($PP),
	{refresh:function(result, diff){	
		if (result.rows.length>0){
			$PP.set("$rowid", result.rows[0].rowid);
			$PP.set("$comment_ids", JSON.parse(result.rows[0].comment_ids)); 
			//dependent table parameter update/refresh...
			svr.comments.tv.refresh();
			svr.issues.tv.refresh();
		}
	}}
);


///// Menu & actions for comments

///// Comment Menu Functions...
svr.comments={};

svr.comments.down=function(el){
	//console.log("move dn...");
	array_movedown($PP.$comment_ids, svr.hi.rowid());
	svr.tv.save({comment_ids:$PP.$comment_ids}, $PP.$rowid);
	svr.comments.tv.refresh();
};

svr.comments.edit=function(el){
	svr.ed.text(el, function(){
		svr.comments.tv.update(svr.ed.row(), svr.ed.rowid(), true); 
		svr.ed.hide();
	});
};

svr.comments.insert=function(el){
	svr.comments.tv.add( function(r){
		//update comment_id list in parameters object
		array_insert_after($PP.$comment_ids, r.rowid, svr.hi.rowid());
		//update the report table (using parameters), then don't refresh
		svr.tv.save({comment_ids:$PP.$comment_ids}, $PP.$rowid);
		//update the comments table, then refresh (true) to show change
		svr.comments.tv.save(svr.hi.row(), r.rowid, true);
	});
};

svr.comments.remove=function(el){
	//CTV.remove(hi.rowid()); 
	//only removing comment rowid from comment list in report, comment remains in comment table
	//console.log("remove comment_ids, rowid:",$PP.$comment_ids, svr.hi.rowid());
	array_remove($PP.$comment_ids, svr.hi.rowid());
	//console.log("remove ", $PP.$comment_ids);
	svr.tv.update({comment_ids:$PP.$comment_ids}, $PP.$rowid);
	svr.comments.tv.refresh();
};

svr.comments.up=function(el){
	//console.log("move up...");
	//array_moveup($PP.$comment_ids, hi.rowid());
	var index=svr.hi.attr("index");
	array_nth_move($PP.$comment_ids, index, -1);
	svr.tv.save({comment_ids:$PP.$comment_ids}, $PP.$rowid);
	svr.comments.tv.refresh();
};

///// table view for comments
svr.comments.template=function(r){console.log("default template...");};

svr.comments.tv=new TableView(casbah.comments($PP),
	{refresh:function(result, delta){
		console.log("CTV refresh...");
		//console.log("CTV refresh result.rows[0].comment:", JSON.stringify(result.rows));
		array_rowidorder(result.rows, $PP.$comment_ids); 
		//console.log("CTV refresh result.rows[0].comment ORDERED:", JSON.stringify(result.rows));
		renderFX("#comments-placeholder", svr.comments.template, result, delta);
	}}
);


// text editor
svr.ed=new Editor();
// highligher
svr.hi=new Highlighter("highlite");



// initialize context menu...
svr.comments.menu=$("#comments-menu").menu().css("position","absolute", "width", "200px").hide();
svr.comments.template=Handlebars.compile($("#comments-template").html());

///// Issues
// table view for issues-closed
svr.issues={};
svr.issues.tv=new TableView(casbah.issues($PP),
	{refresh:function(result, delta){
		//TODO: filter result based on applicable dates...
		renderFX("#issues-closed-placeholder", svr.issues.template, result, delta);
		renderFX("#issues-open-placeholder", svr.issuesOpen.template, result, delta);
	}}
);
//console.log("svr.issues.tv:",svr.issues.tv);
svr.issues.edit=function(el){
	ed.text(el, function(){
		svr.issues.tv.update(svr.ed.row(), svr.ed.rowid(), true); 
		svr.ed.hide();
	});
};
svr.issues.menu=$("#issues-menu").menu().css("position","absolute", "width", "200px").hide();
svr.issues.template=Handlebars.compile($("#issues-closed-template").html());
svr.issuesOpen={};
svr.issuesOpen.template=Handlebars.compile($("#issues-open-template").html());

// Start rendering the page 
// function templates
$("<div>template</div>").load("views/document_header.html", function(htm){
	//console.log('tbh loaded:', htm);
	svr.document_header=Handlebars.compile(htm);
	renderFX("document-header", svr.document_header, $PP);
});

//$("#document-titleblock-template").load("views/document_titleblock.html", function(htm){
$("<div>template</div>").load("views/document_titleblock.html", function(htm){
	//console.log('tbt loaded:', htm);
	svr.titleblock.template=Handlebars.compile(htm);
	//renderFX("document-titleblock", svr.titleblock.template, $PP);
	svr.titleblock.tv.refresh();	
});

//render report table which renders dependent comments and issues table-views also
//$("#reportdock").one("load",svr.tv.refresh);
svr.tv.refresh();


</script>


<!-- TEMPLATES -->
<template id='general-template' type="text/x-handlebars-template">
	<div class="row marz">
		<h3 class="col-xs-1 marz">1.0</h3>
		<h3 class="col-xs-10 border-left marz">General</h3>
		<h3 class="col-xs-1 marz">Ref.</h3>
	</div>
	<div class="row marz">
		<p class="col-xs-1 marz">1.1</p>
		<p id="generalComment" class="col-xs-10 border-left marz" >general comment</p>
		<p class="col-xs-1 marz">--</p>
	</div>
</template>

<template id='comments-template' type="text/x-handlebars-template">

	<div class="row marz" 
		onmouseenter="svr.hi.light(this)"
		oncontextmenu="showMenu(svr.comments.menu, event)" >
		<h3 class="col-xs-1 marz" >2.0</h3>
		<h3 class="col-xs-10 border-left marz">Comments and Observatons</h3>
		<h3 class="col-xs-1 marz" >Pic.</h3>
	</div>

	{{#each rows}}
	<div class="row marz"
		id="comment{{rowid}}"
		rowid="{{rowid}}"
		index="{{@index}}"
		onmouseenter="svr.hi.light(this)"
		oncontextmenu="showMenu(svr.comments.menu, event)">
	<p 	rowid="{{rowid}}" class="col-xs-1 marz">2.{{plusOne @index}}</p>
	<p 	field="comment"
		rowid="{{rowid}}"
		onclick="svr.comments.edit(this)"
		class="col-xs-10 border-left marz">{{comment}}</p>	
	<p 	rowid="{{rowid}}" class="col-xs-1 marz">{{rowid}}</p>	
	</div>
	{{/each}}	
</template>

<template id='issues-closed-template' type="text/x-handlebars-template">

	<div class="row marz"
		oncontextmenu="showMenu(svr.issues.menu, event)"
		onmouseenter="svr.hi.light(this)">
		<h3 class="col-xs-1 marz">3.0</h3>
		<h3 class="col-xs-10 border-left marz">Issues Resolved</h3>
		<h3 class="col-xs-1 marz">Ref</h3>
	</div>

	{{#each rows}}
	<div class="row marz"
		rowid="{{rowid}}"
		index="{{@index}}"
		onmouseenter="svr.hi.light(this)"
		oncontextmenu="showMenu(svr.issues.menu, event)">
	<p 	class="col-xs-1 marz"
		rowid="{{rowid}}"
		index="{{@index}}">3.{{plusOne @index}}</p>
	<p 	field="desc"
		rowid="{{rowid}}"
		index="{{@index}}"
		onclick="svr.issues.edit(this)"
		class="col-xs-10 border-left marz">{{desc}}</p>	
	<p 	rowid="{{rowid}}"
		index="{{@index}}"
		class="col-xs-1 marz">{{rowid}}</p>	
	</div>
	{{/each}}	
</template>

<template id='issues-open-template' type="text/x-handlebars-template">
	{{#each rows}}
	<div class="row marz"
		rowid={{rowid}}
		onmouseenter="svr.hi.light(this)"
		oncontextmenu="showMenu(svr.issues.menu, event)">
	<p 	rowid={{rowid}}
		class="col-xs-1 marz">4.{{plusOne @index}}</p>
	<p 	field="desc"
		rowid={{rowid}}
		onclick="svr.issues.edit()"
		class="col-xs-10 border-left marz">{{desc}}</p>	
	<p 	rowid={{rowid}}
		class="col-xs-1 marz">{{rowid}}</p>	
	</div>
	{{/each}}	
</template>

<!-- MENUS -->
<div id="comments-menu" onmouseleave="svr.comments.menu.hide()" class="hide9999">
	<p onclick="svr.comments.remove()">Delete</p>
	<p onclick="svr.comments.insert()">Insert</p>
	<p onclick="svr.comments.up()">Move up</p>
	<p onclick="svr.comments.down()">Move down</p>
	<p onclick="svr.comments.menu.hide()">Exit</p>
	<p onclick="svr.tv.refresh();svr.comments.menu.hide()">Refresh</p>
</div>

<div id="issues-menu" onmouseleave="svr.issues.menu.hide()" style="display:none; z-index:10000">
	<p onclick="svr.issues.tv.insert(true)">Insert</p>
	<p onclick="svr.issues.tv.remove(svr.hi.rowid())">Delete</p>
	<p onclick="svr.issues.menu.hide()">Exit</p>
</div>

<!-- PAGE STARTS HERE -->

<div class="container">
	<div id="document-header">placeholder</div>
	<div id="document-titleblock">placeholder</div>
	<p class="row row_" >This report is a general review of progress and construction activities on site.  Architectural Work was visually reviewed on a random basis for general conformity with Architectural Contract Documents prepared by this firm.  Refer also to Mechanical and Electrical field reports issued separately.  
	</p>
	<br><br>
	<div id="general-placeholder" class="marz"></div>
	<div id="comments-placeholder" class="marz"></div>
	<div id="issues-closed-placeholder" class="marz"></div>
	<div id="issues-open-placeholder" class="marz"></div>
	<div id="pictures-placeholder" class="marz"></div>
	<br><br>
</div>
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title id='browserTab' >browserTab</title>
<style>
fieldset {border: 0;}
.savable {width:200px;}
label {display: block;  margin: 30px 0 0 0; }
select {width: 200px; }
.overflow {height:200px;}
.border-left {border-left:2px solid #000;}
.marz{margin-top:0px; margin-bottom:0px;}
.row_{border-bottom:1px solid #aaa;}
.row__{border-top:2px solid #000; border-bottom:1px solid #aaa;} 

p, h2, h3, strong {font-family:'segoe';}

textarea {
font-family:'segoe';
background-color:silver;
}


.pocket {
	margin:5px;
	padding:5px;
	height:250px;
	display:block;
	border:1px solid gray;
}
.pocket-caption{height:20px;}
.pocket-row{height:300px;}
</style>


<script type='text/javascript'>

///// Global defs

function showMenu(cm$, ev){
	//first call texteditor with no arguments to turn it off just in case its on
	ed.hide();
	cm$.show().position({my:'left top',	at:'left bottom', of:ev});
	//remember caller, that is the <div> or <p> element that launched the contextMenu
	cm$.menu('option', 'caller', ev.target);
	return false;
};

function selectFolder(e) {
    var theFiles = e.target.files;
    var relativePath = theFiles[0].webkitRelativePath;
    var folder = relativePath.split("/");
    alert(folder[0]);
};


// Cookies & parameters 
var $user=cookie("$user");
if ($user==null){$user=cookie("$user", "admin", "30");};
var $pnum=cookie("$pnum");
if ($pnum==null){$pnum=cookie("$pnum", "BLDG-001", "30");};
//var $svrnum=cookie("$svrnum");
var $svrnum="SVR-A001";
if ($svrnum==null){$svrnum=cookie("$svrnum", "SVR-001", "30");};



///// TableViews

// Site visit report
var $cids="none";
var svrTV=new TableView({
	table:"svrs",
	//svrnum, pnum, title, dateofvisit, timeofvisit, dateofreport, reviewer, xdata
	defrow:{
		svrnum:"SVR-A001",
		pnum:"BLDG-001", 		
		title:"New comment", 
		review_date:Date(), 
		publish_date:"not-issued", 
		comment_ids:"1, 2, 3, 4, 5", 
		issue_ids:"1, 2, 3, 4, 5",
		picture_ids:"none",
		reviewer:$user,
		xdata:"{comments:[1,2,3,4,5], issues:[1,2,3,4,5], pictures:[]}"
	},
	select:" svrnum = $svrnum ",
	params:{"$svrnum":$svrnum},
	render:function(result){	
		console.log("svrTV render result.rows:", JSON.stringify(result.rows));
		if (result.rows.length==0 ) {
			//be carefull, insert calls back this render so if row remains 0 then recursive hell
			svrTV.insert();
		}
		//could call render comments here also
	}, 
	reless:function(result, rowid){
		console.log("svrTV renless result:", result.rows);
		$cids=result.rows[0].comment_ids;
		console.log("svrTV result.rows[0].comment_ids:", $cids);
	
	}, 
	remore:function(result, rowid){
		console.log("svrTV remore result:", result.rows);
		$cids=result.rows[0].comment_ids;
		console.log("svrTV result.rows[0].comment_ids:", $cids);
	
	}
});

// table view for comments
var CM$;
var CTemp=function(){};
var CTV=new TableView({
	table:"comments",
	defrow:{pnum:"BLDG-001", comment:"New comment", refs:"none", date:Date(), by:$user},
	//select:" pnum = $pnum ",
	select:" rowid IN ( $cids )",
	params:{"$pnum":$pnum, "$cids":function(){return $cids;} },
	render:function(result){ 
		console.log("comments render...", result);
		console.log("comments SQLselect...", CTV.SQLselect());
		$('#comments-placeholder').html(CTemp(result));
	}, 
	reless:function(result, rowid){ 
		//console.log("reless...");
		//Grand send-off for deleted row then run callback function to render result
		$("#comments-row"+rowid).css('background','gold').hide(500, function(){
			$('#comments-placeholder').html(CTemp(result));
		});
	}, 
	remore:function(result, rowid){ 
		//console.log("remore new rowid...", rowid);
		$('#comments-placeholder').html(CTemp(result));
		//Grand Reveal...
		var cr$=$('#comments-row'+rowid);
		var callback=function(){cr$.css('background','white');};
		cr$.css('background','gold').hide().show(500, callback);
	}
});

// table view for issues-closed
var icM$;
var icTemp;
var icTV=new TableView({
	table:"issues",
	defrow:{pnum:"BLDG-001", desc:"New closed issue", open:Date(), shut:"date", refs:"1 2 3", by:$user},
	select:" pnum = $pnum ",
	params:{"$pnum":$pnum},
	render:function(result){
		//TODO: filter result based on applicable dates...
		$('#issues-closed-placeholder').html(icTemp(result));
	}, 
	reless:function(result, rowid){ //console.log("reless...");
		//TODO: filter result based on applicable dates...
		//Grand send-off for deleted row then run callback function to render result
		$("#issues-closed-row"+rowid).css('background','gold').hide(500, function(){
			$('#issues-closed-placeholder').html(icTemp(result));
		});
	}, 
	remore:function(result, rowid){ //console.log("remore new rowid...", rowid);
		//TODO: filter result based on applicable dates...
		$('#issues-closed-placeholder').html(icTemp(result));
		//Grand Reveal...
		$('#issues-closed-row'+rowid).css('background','gold').hide().show(500);
		var icr$=$('#issues-closed-row'+rowid);
		var callback=function(){icr$.css('background','white');};
		icr$.css('background','gold').hide().show(500, callback);
	}
});

// table view for issues-open
var ioM$;
var ioTV;
var ioTemp;
var ioTV=new TableView({
	table:"issues",
	defrow:{pnum:"BLDG-001", desc:"New issue", open:Date(), shut:"date", refs:"123", by:"--"},
	select:" pnum = $pnum ",
	params:{"$pnum":$pnum},
	render:function(result){ 
		//TODO: filter result based on applicable dates...
		$('#issues-open-placeholder').html(ioTemp(result));
	}, 
	reless:function(result, rowid){ 
		//console.log("reless...");
		//TODO: filter result based on applicable dates...
	
		//Grand send-off for deleted row then run callback function to render result			
		$("#issues-open-row"+rowid).css('background','gold').hide(500, function(){
			$('#issues-open-placeholder').html(ioTemp(result));
		});
	},
	remore:function(result, rowid){ 
		//console.log("remore new rowid...", rowid);
		//TODO: filter result based on applicable dates...
		$('#issues-open-placeholder').html(ioTemp(result));
		//Grand Reveal...
		$('#issues-open-row'+rowid).css('background','gold').hide().show(500);
		var ior$=$('#issues-open-row'+rowid);
		var callback=function(){ior$.css('background','white');};
		ior$.css('background','gold').hide().show(500, callback);	}
});	

// text editor
var ed=new Editor();
// highligher
var hi=new Highlighter("skyblue");

///// READY
$(function() { 

	// Setup Handlebars
	Handlebars.registerHelper("plusOne", function(val,options){return parseInt(val)+1;});

	svrTV.init();
	
	///// Comments
	// initialize context menu...
	CM$=$("#comments-menu").menu().css("position","absolute", "width", "200px").hide();
	// get template html then compile it to a template-function 
	CTemp=Handlebars.compile($("#comments-template").html());
	CTV.init();
	
	///// issues closed
	icM$=$("#issues-closed-menu").menu().css("position","absolute", "width", "200px").hide();
	icTemp=Handlebars.compile($("#issues-closed-template").html());
	icTV.init();

	///// issues open
	ioM$=$("#issues-open-menu").menu().css("position","absolute", "width", "200px").hide();
	ioTemp=Handlebars.compile($("#issues-open-template").html());
	ioTV.init();

}); //READY



</script>

</head>



<body>


<!-- TEMPLATES               -->
<template id='comments-template' type="text/x-handlebars-template">

	{{#each rows}}
	<div class="row marz"
		id="comments-row{{rowid}}"
		rowid={{rowid}}
		onmouseenter='hi.light(this)'
		oncontextmenu='showMenu(CM$, event)'>
	<p 	rowid={{rowid}}
		class='col-xs-1 marz'
		style="height:100%;">2.{{plusOne @index}}</p>
	<p 	field="comment"
		rowid={{rowid}}
		onclick="ed.text(this, function(){CTV.update(ed.row(), ed.rowid()); ed.hide();})"
		class="col-xs-10 border-left marz">{{comment}}</p>	
	<p 	rowid={{rowid}}
		class='col-xs-1 marz'>{{rowid}}</p>	
	</div>
	{{/each}}	
</template>

<template id='issues-closed-template' type="text/x-handlebars-template">
	{{#each rows}}
	<div class="row marz"
		id="issues-closed-row{{rowid}}"
		rowid={{rowid}}
		onmouseenter='hi.light(this)'
		oncontextmenu='showMenu(icM$, event)'>
	<p 	class='col-xs-1 marz'>3.{{plusOne @index}}</p>
	<p 	field="desc"
		rowid={{rowid}}
		onclick="ed.text(this, function(){icTV.update(ed.row(), ed.rowid()); ed.hide();})"
		class="col-xs-10 border-left marz">{{desc}}</p>	
	<p 	rowid={{rowid}}
		class='col-xs-1 marz'>{{rowid}}</p>	
	</div>
	{{/each}}	
</template>

<template id='issues-open-template' type="text/x-handlebars-template">
	{{#each rows}}
	<div class="row marz"
		id="issues-open-row{{rowid}}"
		rowid={{rowid}}
		onmouseenter='hi.light(this)'
		oncontextmenu='showMenu(ioM$, event)'>
	<p 	rowid={{rowid}}
		class='col-xs-1 marz'>4.{{plusOne @index}}</p>
	<p 	field="desc"
		rowid={{rowid}}
		onclick="ed.text(this, function(){ioTV.update(ed.row(), ed.rowid()); ed.hide();})"
		class="col-xs-10 border-left marz">{{desc}}</p>	
	<p 	rowid={{rowid}}
		class='col-xs-1 marz'>{{rowid}}</p>	
	</div>
	{{/each}}	
</template>

<!-- MENUS -->
<div id="comments-menu" onmouseleave="CM$.hide()" style="display:none; z-index:10000">
	<p onclick="CTV.insert()">Insert</p>
	<p onclick="CTV.remove(hi.rowid())">Delete</p>
	<p onclick="CM$.hide()">Exit</p>
</div>

<div id="issues-closed-menu" onmouseleave="icM$.hide()" style="display:none; z-index:10000">
	<p onclick="icTV.insert()">Insert</p>
	<p onclick="icTV.remove(hi.rowid())">Delete</p>
	<p onclick="icM$.hide()">Exit</p>
</div>

<div id="issues-open-menu" onmouseleave="ioM$.hide()" style="display:none; z-index:10000">
	<p onclick="ioTV.insert()">Insert</p>
	<p onclick="ioTV.remove(hi.rowid())">Delete</p>
	<p onclick='ioM$.hide()'>Exit</p>
</div>


<!-- PAGE STARTS HERE -->

<div class='container'>
	<img src='./images/private/logo.png' style='width:100px; float:left;'>
	<h2  style='float:right;' >Field Review Report</h2><div style='clear:both'></div>
	<br><br>

	<div class='row row__'>
		<strong class='col-xs-2'>Report No:</strong>
		<p id='docName' class='col-xs-4'>SVR-A01</p>
		<strong class='col-xs-2'>Permit No:</strong>
		<p id='permitNo' class='col-xs-4 soup-cell'>16 xxxxxx BLD 00 BA</p>
	</div>

	<div class='row row_'>
		<strong class='col-xs-2'>Project:</strong>
		<p class='col-xs-4'>Some Street Building Redevelopment</p>
		<strong class='col-xs-2'>Date of Visit:</strong>
		<p id='visitDate' class='col-xs-4 soup-cell'>June 15 &amp; 17, 2016</p>
	</div>
	
	<div class='row row_'>
		<strong class='col-xs-2'>Project No.:</strong>
		<p class='col-xs-4'>BLDG-0001</p>
		<strong class='col-xs-2'>Time of Visit:</strong>
		<p id='visitTime' class='col-xs-4 soup-cell'>4pm to 6pm</p>
	</div>
				
	<div class='row row_'>
		<strong class='col-xs-2'>Project Location:</strong>
		<p class='col-xs-4'>123 Some Street, City, Prov, M5B 1W8</p>
		<strong class='col-xs-2'>Reviewer:</strong>
		<p id='reviewerName' class='col-xs-4 soup-cell'>Andrew Siddeley</p>
	</div>

	<div class='row row_'>
		<strong class='col-xs-2'>Contractor:</strong>
		<p class='col-xs-4'>GC</p>
		<strong class='col-xs-2'>Date of Report:</strong>
		<p id='reportDate' class='col-xs-4'>Jun 17, 2016</p>
	</div>
	
	<div class='row row_ '>
		<p id='generalStatement'
		class='col-xs-12' 
		table="general"
		field="values"
		select="name='svrstatement'"
		onmouseenter="hi.light(this)"
		onclick="ed.text(this, function(ev){ ed.hide();})"
		>This report is a general review of progress and construction activities on site.  Architectural Work was visually reviewed on a random basis for general conformity with Architectural Contract Documents prepared by this firm.  Refer also to Mechanical and Electrical field reports issued separately.  
		</p>
	</div>	

	<br><br>

	<div class='row marz'>
		<h3 class='col-xs-1 marz'>1.0</h3>
		<h3 class='col-xs-10 border-left marz'>General</h3>
		<h3 class='col-xs-1 marz'>Ref.</h3>
	</div>
	
	<div class='row marz'>
		<p class='col-xs-1 marz'>1.1</p>
		<p id='generalComment' class='col-xs-10 border-left marz' >general comment</p>
		<p class='col-xs-1 marz'>--</p>
	</div>

	<div class='row marz' 
		onmouseenter='hi.light(this)'
		oncontextmenu='showMenu(CM$, event)' >
		<h3 class='col-xs-1 marz' >2.0</h3>
		<h3 class='col-xs-10 border-left marz'>Comments and Observatons</h3>
		<h3 class='col-xs-1 marz' >Pic.</h3>
	</div>
	
	<!-- Placeholder -->
	<div id='comments-placeholder' class='marz'></div>

	<div class="row marz"
		oncontextmenu="showMenu(icM$, event)"
		onmouseenter="hi.light(this)">
		<h3 class='col-xs-1 marz'>3.0</h3>
		<h3 class='col-xs-10 border-left marz'>Issues Resolved</h3>
		<h3 class='col-xs-1 marz'>Ref</h3>
	</div>

	<!-- Placeholder -->
	<div id='issues-closed-placeholder' class='marz'></div>
	
	<div class='row marz'
		oncontextmenu="showMenu(ioM$, event)"
		onmouseenter="hi.light(this)">
		<h3 class='col-xs-1 marz'>4.0</h3>
		<h3 class='col-xs-10 border-left marz'>Issues Outstanding</h3>
		<h3 class='col-xs-1 marz'>Ref</h3>
	</div>

	<!-- Placeholder -->
	<div id='issues-open-placeholder' class='marz'></div>

	<div class='row marz'>
		<h3 class='col-xs-1 marz'>5.0</h3>
		<h3 class='col-xs-10 border-left marz'>Pictures</h3>
		<h3 class='col-xs-1 marz'>Pic.</h3>
	</div>
	
	<!-- Placeholder -->
	<div id='pictures-placeholder' class='marz'></div>


<br><br><br><br>
</div>
</body>
</html>

